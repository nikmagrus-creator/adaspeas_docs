services:
  # init-app-data: one-shot контейнер, который гарантирует, что ./data существует
  # и принадлежит UID/GID приложения. Это важно при первом запуске: Docker может
  # создать bind-mount директорию как root:root, из-за чего SQLite (WAL) падает
  # с "attempt to write a readonly database".
  init-app-data:
    image: alpine:3.19
    restart: "no"
    user: "0:0"
    command: ["sh", "-lc", "mkdir -p /data && chown -R ${APP_UID:-1000}:${APP_GID:-1000} /data"]
    volumes:
      - ./data:/data

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10

  local-bot-api:
    image: aiogram/telegram-bot-api:latest
    profiles: ["localbotapi"]
    restart: unless-stopped
    environment:
      TELEGRAM_API_ID: ${TELEGRAM_API_ID:-}
      TELEGRAM_API_HASH: ${TELEGRAM_API_HASH:-}
      TELEGRAM_LOCAL: "1"
    volumes:
      - ./data/telegram-bot-api:/var/lib/telegram-bot-api


  bot:
    build:
      context: .
      args:
        UID: ${APP_UID:-1000}
        GID: ${APP_GID:-1000}
    restart: unless-stopped
    command: ["python", "-m", "adaspeas.bot.main"]
    env_file: ${ENV_FILE:-.env}
    volumes:
      - ./data:/data
    depends_on:
      init-app-data:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8080/health', timeout=2).read()"]
      interval: 10s
      timeout: 3s
      retries: 30
      start_period: 30s

  worker:
    build:
      context: .
      args:
        UID: ${APP_UID:-1000}
        GID: ${APP_GID:-1000}
    restart: unless-stopped
    command: ["python", "-m", "adaspeas.worker.main"]
    env_file: ${ENV_FILE:-.env}
    volumes:
      - ./data:/data
    depends_on:
      init-app-data:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    ports:
      - "8081:8081"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8081/health', timeout=2).read()"]
      interval: 10s
      timeout: 3s
      retries: 30
      start_period: 30s

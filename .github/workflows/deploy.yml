name: build-and-deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write

concurrency:
  group: adaspeas-prod
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image: ghcr.io/${{ github.repository }}:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Repo hygiene (.env must not be tracked, except .env.example)
        shell: bash
        run: |
          set -euo pipefail
          bad="$(
            git ls-files -z -- '.env' '.env.*' \
              | tr '\0' '\n' \
              | grep -vE '(^|/)\.env\.example$' \
              || true
          )"
          if [ -n "$bad" ]; then
            echo "ERROR: tracked .env file(s) found. Only .env.example is allowed."
            printf '%s\n' "$bad"
            exit 1
          fi
          # NOTE: .env.example is intentionally tracked; everything else matching .env / .env.* is forbidden.

      - name: Docs policy check (timestamps + no doc sprawl)
        shell: bash
        run: |
          set -euo pipefail

          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          echo "Checking docs policy for changes: $BEFORE..$AFTER"

          changed_files="$(git diff --name-only "$BEFORE" "$AFTER" || true)"
          added_docs="$(git diff --name-status "$BEFORE" "$AFTER" | awk '$1=="A" && $2 ~ /^docs\// {print $2}' || true)"

          # No new docs files unless ADR/CHATLOG
          if [ -n "${added_docs}" ]; then
            bad="$(echo "${added_docs}" | grep -Ev '^(docs/adr/|docs/CHATLOG_RU\.md$)' || true)"
            if [ -n "${bad}" ]; then
              echo "ERROR: New docs files are not allowed (except ADR/CHATLOG)."
              echo "${bad}"
              exit 1
            fi
          fi

          # Living docs must have timestamp + change log table
          living_docs="docs/INDEX_RU.md docs/WORKFLOW_CONTRACT_RU.md docs/PRD_RU.md docs/TECH_SPEC_RU.md docs/OPS_RUNBOOK_RU.md docs/ROADMAP_RU.md docs/DOCS_RATIONALE_RU.md"

          for f in ${living_docs}; do
            if echo "${changed_files}" | grep -qx "${f}"; then
              echo "Validating living doc: ${f}"
              grep -q '^Актуально на: [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\} [0-9]\{2\}:[0-9]\{2\} MSK' "${f}"
              grep -q '^## История изменений' "${f}"

              # Table must contain at least one data row with MSK
              if ! grep -E '^[|].*MSK.*[|]' "${f}" >/dev/null; then
                echo "ERROR: ${f} must contain at least one history row in the table."
                exit 1
              fi
            fi
          done

          echo "Docs policy check passed."

      - name: Python sanity (compile + tests if any)
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Compile + pytest
        run: |
          python -m compileall -q src
          pytest -q || test $? -eq 5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push
        id: meta
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ github.sha }}


  ci-smoke:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure .env exists for Compose
        shell: bash
        run: |
          if [ ! -f .env ]; then
            if [ -f .env.example ]; then
              cp .env.example .env
            else
              : > .env
            fi
          fi

      - name: Dockerfile lint (hadolint)
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          no-fail: true

      - name: Trivy report (fs, SARIF)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: fs
          scan-ref: .
          format: sarif
          output: trivy-results.sarif
          exit-code: 0
          ignore-unfixed: true

      - name: Upload Trivy SARIF
        if: always() && hashFiles('trivy-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif

      - name: Trivy gate (fs, fail on HIGH/CRITICAL)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: fs
          scan-ref: .
          format: table
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: 1
          skip-setup-trivy: true

      - name: Compose config validate (dev)
        run: docker compose -f docker-compose.yml config

      - name: Start stack (dev)
        run: docker compose -f docker-compose.yml up -d --build

      - name: Wait for /health (bot 8080, worker 8081)
        run: |
          set -eu
          for i in $(seq 1 60); do
            if curl -fsS "http://localhost:8080/health" >/dev/null && curl -fsS "http://localhost:8081/health" >/dev/null; then
              echo "healthy"
              exit 0
            fi
            sleep 2
          done
          echo "healthcheck timeout"
          docker compose -f docker-compose.yml ps
          docker compose -f docker-compose.yml logs --no-color
          exit 1

      - name: Teardown
        if: always()
        run: docker compose -f docker-compose.yml down -v || true

  deploy:
    needs: [build, ci-smoke]
    runs-on: ubuntu-latest
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script_stop: true
          envs: GHCR_USER,GHCR_PAT,APP_DIR,IMAGE
          script: |
            set -euo pipefail
            export APP_DIR="${APP_DIR:-/opt/adaspeas}"
            export IMAGE="${IMAGE:-${{ needs.build.outputs.image }}}"
            if [ ! -d "$APP_DIR" ]; then
              echo "APP_DIR $APP_DIR does not exist. Run deploy/bootstrap_vps.sh on the server first."
              exit 2
            fi
            cd "$APP_DIR"

            # keep VPS repo in sync with GitHub (infra files, docs, compose, caddy)
            git fetch origin
            git reset --hard origin/main
            git clean -fd

            # validate required env vars (fail fast before pulling/up)
            if [ ! -f .env ]; then
              echo "Missing .env in $APP_DIR"
              exit 3
            fi

            required_vars="BOT_TOKEN YANDEX_OAUTH_TOKEN SQLITE_PATH REDIS_URL ACME_EMAIL METRICS_USER METRICS_PASS IMAGE"
            for k in $required_vars; do
              v="$(grep -E "^${k}=" .env | tail -n1 | cut -d= -f2- || true)"
              if [ -z "$v" ]; then
                echo "Missing or empty env var: $k"
                exit 3
              fi
            done


            if [ -n "${GHCR_PAT:-}" ]; then
              echo "$GHCR_PAT" | docker login ghcr.io -u "${GHCR_USER:-${{ github.actor }}}" --password-stdin
            fi

            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d
            docker compose -f docker-compose.prod.yml restart caddy
            docker image prune -f
    env:
      GHCR_USER: ${{ secrets.GHCR_USER }}
      GHCR_PAT: ${{ secrets.GHCR_PAT }}
      APP_DIR: ${{ secrets.APP_DIR }}
      VPS_PORT: ${{ secrets.VPS_PORT }}
      IMAGE: ghcr.io/${{ github.repository }}:latest

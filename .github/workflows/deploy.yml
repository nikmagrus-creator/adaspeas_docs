name: build-and-deploy

'on':
  push:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write
  security-events: write

concurrency:
  group: adaspeas-prod
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image: ghcr.io/${{ github.repository }}:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Repo hygiene (.env must not be tracked, except .env.example)
        shell: bash
        run: |
          set -euo pipefail
          bad="$(
            git ls-files -z -- '.env' '.env.*'               | tr '\0' '\n'               | grep -vE '(^|/)\.env\.example$'               || true
          )"
          if [ -n "$bad" ]; then
            echo "ERROR: tracked .env file(s) found. Only .env.example is allowed."
            printf '%s\n' "$bad"
            exit 1
          fi

      - name: Docs policy check (timestamps + no doc sprawl)
        shell: bash
        run: |
          set -euo pipefail

          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          echo "Checking docs policy for changes: $BEFORE..$AFTER"

          changed_files="$(git diff --name-only "$BEFORE" "$AFTER" || true)"
          added_docs="$(git diff --name-status "$BEFORE" "$AFTER" | awk '$1=="A" && $2 ~ /^docs\// {print $2}' || true)"

          # No new docs files unless ADR/CHATLOG
          if [ -n "${added_docs}" ]; then
            bad="$(echo "${added_docs}" | grep -Ev '^(docs/adr/|docs/CHATLOG_RU\.md$)' || true)"
            if [ -n "${bad}" ]; then
              echo "ERROR: New docs files are not allowed (except ADR/CHATLOG)."
              echo "${bad}"
              exit 1
            fi
          fi

          # Living docs must have timestamp + change log table
          living_docs="docs/INDEX_RU.md docs/WORKFLOW_CONTRACT_RU.md docs/PRD_RU.md docs/TECH_SPEC_RU.md docs/OPS_RUNBOOK_RU.md docs/ROADMAP_RU.md docs/DOCS_RATIONALE_RU.md"

          for f in ${living_docs}; do
            if echo "${changed_files}" | grep -qx "${f}"; then
              echo "Validating living doc: ${f}"
              grep -q '^Актуально на: [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\} [0-9]\{2\}:[0-9]\{2\} MSK' "${f}"
              grep -q '^## История изменений' "${f}"

              # Table must contain at least one data row with MSK
              if ! grep -E '^[|].*MSK.*[|]' "${f}" >/dev/null; then
                echo "ERROR: ${f} must contain a history table row with MSK."
                exit 1
              fi
            fi
          done

  ci-smoke:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure .env exists for Compose
        shell: bash
        run: |
          if [ ! -f .env ]; then
            if [ -f .env.example ]; then
              cp .env.example .env
            else
              : > .env
            fi
          fi

      - name: Dockerfile lint (hadolint)
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          no-fail: true

      - name: Trivy report (fs, SARIF, do not fail)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: fs
          scan-ref: .
          format: sarif
          output: trivy-results.sarif
          exit-code: 0

      - name: Upload Trivy SARIF
        if: ${{ hashFiles('trivy-results.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif

      - name: Trivy gate (fs, fail on HIGH/CRITICAL)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: fs
          scan-ref: .
          format: table
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: 1
          skip-setup-trivy: true

      - name: Compose config validate
        run: docker compose -f docker-compose.yml config

      - name: Start stack
        run: docker compose -f docker-compose.yml up -d --build

      - name: Wait for /health (bot 8080, worker 8081)
        shell: bash
        run: |
          set -eu
          for i in $(seq 1 60); do
            if curl -fsS "http://localhost:8080/health" >/dev/null && curl -fsS "http://localhost:8081/health" >/dev/null; then
              echo "healthy"
              exit 0
            fi
            sleep 2
          done
          echo "healthcheck timeout"
          docker compose -f docker-compose.yml ps || true
          docker compose -f docker-compose.yml logs --no-color || true
          exit 1

      - name: Teardown
        if: always()
        run: docker compose -f docker-compose.yml down -v || true

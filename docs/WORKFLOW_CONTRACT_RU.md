# WORKFLOW_CONTRACT (RU): правила работы с проектом и разработки ассистентом

Актуально на: 2026-02-05 03:00 MSK
Цель: чтобы ассистент мог **самостоятельно** развивать продукт end-to-end (код+доки+деплой через CI) и при этом проект сохранял память: решения, итоги сессий, изменения.

---

## 0) Source of Truth и окружение (обязательные по умолчанию)
Часовой пояс по умолчанию для планирования и формулировок “сегодня/завтра”: **Europe/Moscow (MSK)**.
Таймстемпы в документах и таблицах “История изменений” фиксируем в **MSK** (UTC+3).

- Source of Truth для документации: https://github.com/nikmagrus-creator/adaspeas_docs
- Вложения/архивы из чата считать потенциально устаревшими. При любом сомнении требуется актуальный архив или ссылка на текущий commit.
- Ветка по умолчанию: `main`

Каноничные пути (раз и навсегда):
- Local (Linux Mint), репозиторий: `/home/nik/projects/adaspeas`
- Папка скачивания архивов: `/media/nik/0C30B3CF30B3BE50/Загрузки`
- VPS директория проекта: `/opt/adaspeas`

Хранилище (если используется Яндекс.Диск):
- Основная папка каталога: `Zkvpr` (не `Adaspeas`).

## 0.1) Золотое правило деплоя
- VPS обновляется **только** через репозиторий и CI/CD. Ручные изменения на VPS запрещены.
- Любые изменения: локально → `git commit` → `git push` → CI применяет на VPS.

---

## 1) Роли и ответственность (как мы работаем)
- Пользователь задаёт цель, ограничения, доступы (репозиторий/секреты/архивы) и принимает результат.
- Ассистент выполняет разработку продукта полностью: проектирование, код, тесты/смоки, обновление документации, подготовка инкрементальных пакетов изменений, инструкции применения.

---

## 2) Anti-spam и дисциплина переписки
В чат **нельзя** публиковать:
- большие полотна кода/конфигов/диффов/логов
- содержимое файлов целиком (кроме коротких точечных фрагментов по запросу)

В чат **можно**:
- план, решения, список затрагиваемых файлов, риски
- краткое резюме того, что изменено

---

## 3) Память проекта: где фиксируется “полезное из чата”
Это обязательное правило: любое полезное из переписки должно быть закреплено в репозитории.

### 3.1) Итоги каждой сессии (история чатов)
- После каждой существенной сессии ассистент добавляет запись в `docs/CHATLOG_RU.md`:
  - дата/время MSK
  - цель сессии
  - что сделано (файлы/модули)
  - принятые решения (ссылки на ADR, если применимо)
  - что изменено в living-docs (INDEX/CONTRACT/PRD/TECH/OPS)
  - следующие шаги
- В `CHATLOG_RU.md` мы **не** копируем весь чат, только инженерную выжимку (иначе это превращается в мусор).

### 3.2) Архитектурные решения (почему так)
- Любое решение уровня “архитектура/необратимо/дорого переделать” фиксируется отдельным ADR в `docs/adr/`.
- ADR должен содержать дату/время MSK, статус, контекст, решение, последствия.
- Если ADR заменён: старый помечается `Superseded by ADR-XXX`.

### 3.3) Изменения поведения/контрактов
- Если меняется публичное поведение/контракт/процедуры деплоя: обновить `CHANGELOG.md`.
- Если меняется смысл living-doc: обновить `Актуально на:` и добавить запись в таблицу “История изменений” этого документа.

---

## 4) Дисциплина документов (не плодим)
Living docs проекта (минимальный набор):
- `docs/INDEX_RU.md` (вход/карта)
- `docs/WORKFLOW_CONTRACT_RU.md` (процесс и память)
- `docs/PRD_RU.md` (продукт и границы)
- `docs/TECH_SPEC_RU.md` (контракты и reference)
- `docs/OPS_RUNBOOK_RU.md` (эксплуатация)

Журналы:
- `docs/CHATLOG_RU.md` (итоги сессий)
- `CHANGELOG.md` (заметные изменения)
- `docs/adr/` (решения)

Правило:
- Новые файлы **не создаём**, если можно обновить существующий.
- Разрешённые исключения (это новые *записи*, не новые типы): новые ADR в `docs/adr/`.
- Если добавляется новый тип артефакта: обновить `docs/INDEX_RU.md` и объяснить в “Истории изменений”.

---

## 5) Формат результата любой правки (обязательный)
Любая правка поставляется так:
1) **Инкрементальный архив** (только изменённые файлы/папки, с сохранением путей)
2) Сразу после архива: **один** минимальный блок команд:
   - проверка, что репо чистый
   - распаковка архива в корень репозитория
   - удаление файлов, если требуется (см. `.pack/deleted.txt`)
   - `git add -A`, `git commit`, `git push`

### 5.1) Инкрементальные пакеты (важно)
- Архив содержит **только** изменённые файлы (и их директории).
- Если что-то нужно удалить, архив должен содержать `.pack/deleted.txt` (строка = путь), а команды обязаны удалить эти пути.
- Архив не должен тащить `.git` и прочий мусор.
- Команды должны быть совместимы с VTE/GUI-терминалом:
  - без `set -e`
  - без явного `exit`
  - предпочтительно использовать `|| return` и печать ошибок

---

### 5.2) Стандартный блок команд (применение пакета + push)
Команды должны быть **минимальными**, выполняться целиком в GNOME Terminal/VTE без самозакрытия окна:
- **не** использовать `set -e`, **не** делать `exit`
- для остановки использовать `return` (если запускается в текущей оболочке)

Шаблон (каноничные пути):  
```bash
cd /home/nik/projects/adaspeas || return
test -z "$(git status --porcelain)" || { echo "Repo dirty. Commit/stash first."; return; }

PACK="/media/nik/0C30B3CF30B3BE50/Загрузки/<PACK_NAME>.tar.gz"

tar -xzf "$PACK" -C /home/nik/projects/adaspeas

# удалить то, что пакет пометил как удалённое (если файл существует)
test -f .pack/deleted.txt && while IFS= read -r p; do
  test -n "$p" || continue
  git rm -r --ignore-unmatch "$p" >/dev/null 2>&1 || rm -rf "$p"
done < .pack/deleted.txt

git add -A
git commit -m "<MESSAGE>"
git push
```

Требования к пакету:
- Формат: **tar.gz**
- Содержит **только** изменённые файлы/папки (с сохранением путей)
- Если нужны удаления: добавить `.pack/deleted.txt` (список путей, по одному на строку)
- Запрещено включать в пакет: `.git/`, секреты (`.env`, ключи, токены), большие артефакты сборки, кэши.


## 6) Мини-checklist перед выдачей пакета
Перед тем как объявить “готово”, ассистент проверяет:
- пути корректны (repo/archives/VPS)
- архив распакуется поверх репозитория и не создаст лишний уровень папок
- повторное применение пакета не ломает репозиторий (идемпотентность)
- если есть удаления, они перечислены в `.pack/deleted.txt` и включены в команды

---

## История изменений
| Дата/время (MSK) | Автор | Тип | Кратко | Commit/PR |
|---|---|---|---|---|
| 2026-02-04 15:00 MSK | ChatGPT | contract | Зафиксирован протокол работы “архив + команды”, запрет мусора, дисциплина файлов и истории | |
| 2026-02-04 16:45 MSK | ChatGPT | contract | Уточнено: всегда начинать с GitHub docs-репозитория; вложения считать потенциально устаревшими | |
| 2026-02-04 17:30 MSK | ChatGPT | doc | Зафиксированы каноничные пути (local/VPS) и запрет ручных правок на VPS | |
| 2026-02-05 03:00 MSK | ChatGPT | contract | Переписан контракт под автономную разработку ассистентом: CHATLOG/ADR/CHANGELOG, инкрементальные пакеты, требования к командам | |

# WORKFLOW CONTRACT (RU)

Актуально на: 2026-02-07 17:59 MSK
Этот документ задаёт правила работы. В спорных случаях этот контракт важнее чата, памяти и вложений.


## 0) Source of Truth и окружение (обязательные по умолчанию)

- Часовой пояс по умолчанию для планирования и формулировок “сегодня/завтра”: **Europe/Moscow (MSK)**.
- Таймстемпы в документах/чатлоге: **MSK (UTC+3)**.

Source of Truth для документации:
- GitHub-репозиторий: https://github.com/nikmagrus-creator/adaspeas_docs
- Вложения/архивы из чата считать потенциально устаревшими. При любом сомнении требуется актуальный архив или ссылка на текущий commit.
- Ветка по умолчанию: `main`.

Правило репозитория:
- **Единственная ветка в `origin`: `main`.** Другие ветки **не создаём и не пушим**.
- Работаем линейно: `git pull --ff-only`, затем коммит, затем `git push`.
- Если случайно появилась лишняя ветка: **не делаем merge/cherry-pick/rebase.**
  - Если ветка не нужна: удалить её локально/на `origin`.
  - Если изменения нужны: собрать их заново в pack и применить в `main` (см. `docs/PACK_APPLY_TEMPLATE_RU.md`).


Каноничные пути (раз и навсегда):
- Local (Linux Mint), репозиторий: `/home/nik/projects/adaspeas`
- Папка скачивания паков: `/media/nik/0C30B3CF30B3BE50/Загрузки`
- VPS директория проекта: `/opt/adaspeas`

Хранилище (если используется Яндекс.Диск):
- Корневая папка каталога: `Zkvpr` (не `Adaspeas`).
- В интерфейсе бота название внешнего хранилища и внутренние пути **не показываем**.


## 0.1) Золотое правило деплоя

- VPS обновляется **только** через репозиторий и CI/CD. Ручные изменения на VPS запрещены.
- Любые изменения: локально → `git commit` → `git push` → CI применяет на VPS.


## 0.2) Если GitHub/remote недоступен (trade controls / блокировки)

Случаи, когда GitHub временно недоступен (DNS/сеть, trade controls, санкции), считаются нормальным внешним риском.

Правила:
- Коммиты делаем локально как обычно, история не теряется.
- Держим fallback remote (зеркало) на альтернативном хостинге (Codeberg/GitLab/self-hosted Gitea).
- Временный перевод репозитория в public допустим только как вынужденная мера:
  - секреты/ключи/токены в git запрещены;
  - факт и причина фиксируются в `docs/CHATLOG_RU.md` (дата/время MSK + план возврата).


## 1) Документация: структура, приоритет, запреты

Порядок чтения и обновления:
1) `docs/INDEX_RU.md`
2) `docs/WORKFLOW_CONTRACT_RU.md`
3) `docs/CHATLOG_RU.md`
4) `docs/adr/`

Назначение документов:
- `INDEX_RU.md` — точка входа и карта документации.
- `PRD_RU.md` — что строим и зачем (продуктовые требования).
- `TECH_SPEC_RU.md` — как устроено (архитектура и контракты компонентов).
- `OPS_RUNBOOK_RU.md` — как запускать/обслуживать/чинить.
- `ROADMAP_RU.md` — приоритеты и этапы.
- `CHATLOG_RU.md` — итоги сессий и короткие фиксации изменений.
- `adr/` — отдельные архитектурные решения (ADR).

Запрет на «плодить файлы»:
- Новые файлы/доки добавляем **только** когда появляется новый тип артефакта, которого раньше не было.
- Если тип артефакта уже существует, **обновляем существующий документ**, а не создаём “ещё один файл правил”.
- Исключение: новый ADR допустим, когда принято значимое решение и его нужно зафиксировать отдельно.


## 2) Изменения только пакетами (incremental pack)

Любые изменения в репозитории передаются и применяются только через **.tar.gz пакет**, который распаковывается в корень репозитория.

Пакет может содержать:
- изменённые файлы;
- новые файлы (только если это разрешено правилами раздела 1);
- служебную папку `.pack/`:
  - `.pack/deleted.txt` — список путей для удаления (по одному пути в строке).

После применения пакета папка `.pack` удаляется.


## 2.1) Каноничный шаблон применения пакета

Единственный актуальный шаблон команд находится в `docs/PACK_APPLY_TEMPLATE_RU.md`.

Обязательное правило выдачи результата:
- Если ассистент **выдал pack/архив**, он обязан **в этом же сообщении** дать **один каноничный блок команд** из шаблона, где:
  - `<PACK_NAME>` заменён на **фактическое имя** выданного `.tar.gz`;
  - сообщение `git commit -m ...` уже задано (по‑русски), чтобы команды были copy‑paste.

Правило простое: **любые замечания и улучшения сначала правим в шаблоне**, а в этом контракте держим только политику и ссылки.

Короткая логика применения pack:
- работаем только в `main` и подтягиваем `origin/main` линейно (`git pull --ff-only`);
- снимаем/абортим любые незавершённые операции (merge/cherry-pick/rebase) и приводим дерево в чистое состояние;
- распаковываем pack, применяем `.pack/deleted.txt`, удаляем `.pack`;
- `git add -A`, коммит, push в `main`.

## 2.2) Нулевая терпимость к веткам: чистка origin и локальных refs

Если в репозитории внезапно появились ветки (например, `dependabot/*` или случайно созданная `ops/*`), их нужно удалить, чтобы не нарушать правило “только main”.

Удаление удалённой ветки делается через `git push origin :<branch>` (пустой source ref удаляет ветку).

Проверить, что есть лишнее:
```bash
git fetch origin --prune
git branch -r
```

Автоматическая чистка: удалить ВСЁ на origin кроме `main` (и затем удалить локальные ветки кроме `main`):
```bash
# ВНИМАНИЕ: выполняй только если уверен(а), что все нужные коммиты уже в main.
git fetch origin --prune &&

for b in $(git for-each-ref refs/remotes/origin --format='%(refname:strip=3)' | grep -vE '^(main|HEAD)$'); do
  echo "delete origin/$b"
  git push origin ":$b"
done &&

git fetch origin --prune &&

for b in $(git for-each-ref refs/heads --format='%(refname:strip=2)' | grep -vE '^(main)$'); do
  echo "delete local $b"
  git branch -D "$b"
done
```

Почему это важно: Docker/Compose и CI у нас привязаны к линейному процессу изменений и автодеплою из `main`. Любая “временная ветка” превращается в долговременную проблему.


## 3) Коммиты: только по-русски

Требование: сообщения коммитов пишем **только на русском**.

Рекомендуемый формат:
- Одна строка: `<тип>: <кратко, русскими словами>`
- Типы: `docs`, `feat`, `fix`, `refactor`, `ops`, `chore`, `test`.
- Без точки в конце строки.
- Желательно ≤ 72 символов (не критично, но удобно).
- Если нужен подробный контекст, добавляется тело коммита (тоже по-русски).

Примеры:
- `docs: зафиксировать полную спецификацию связки Telegram + Диск + VPS`
- `feat: добавить inline-навигацию каталога и кнопку Назад`
- `fix: не показывать пользователю внутренние названия хранилища`


## 4) Правила общения в чате разработки

- В чате пишем минимум: что сделано, что в пакете, какую команду применить, какой коммит.
- Если сообщение содержит ссылку/файл pack, то **сразу ниже** идёт готовый блок команд (без плейсхолдеров, кроме тех, что пользователь должен осознанно заменить).
- Команды не “обсуждаем”, а выдаём в одном каноничном блоке (раздел 2.1).
- Если нужно поменять правило, оно меняется в этом контракте и фиксируется в `docs/CHATLOG_RU.md`.

## 4.1) Выбор источника для работы (GitHub / архив / внешние факты)

Перед началом **любой** задачи ассистент обязан вывести блок **PRE-FLIGHT** в фиксированном формате:

```
PRE-FLIGHT
- Режим: GitHub main | Архив (.zip) | Инкрементальный pack | Web (внешние факты)
- Нужно от пользователя: (что подключить/загрузить/дать ссылки) или «ничего»
- Интернет: нужен/не нужен
- Результат: (что будет на выходе: ответ / pack / список файлов / отчёт)
- План: 1) … 2) … 3) …
```


Правило выбора:
- **Проверить / сверить / исправить по текущему `main`** → нужен **GitHub-коннектор** (это Source of Truth).
- **Сделать большие правки и не зависеть от состояния GitHub** → нужен **полный архив репозитория** или **инкрементальный pack** (актуальный).
- **Нужны точные внешние факты** (лимиты, API, регламенты, изменения у провайдеров) → ассистент обязан проверить через интернет и дать ссылки на первоисточники. Если интернет недоступен, пользователь предоставляет источник (ссылка/выдержка/файл), иначе это считается предположением.

Если есть расхождение между архивом и `main`, приоритет у `main` (раздел 0: Source of Truth).


## 4.2) Фиксация изменений, идей и решений (память проекта)

Цель: после каждого патча и каждого обсуждения в репозитории остаётся короткий след, чтобы новый чат/ИИ не гадал.

Правила:
- **Реализованное изменение (код/инфра/поведение)** → запись в `CHANGELOG.md` (в `## [Unreleased]`) + при необходимости короткая запись в `docs/CHATLOG_RU.md`.
- **Идея/улучшение, которое ещё не сделано** → строка в backlog в `docs/ROADMAP_RU.md` с ID вида `IDEA-###` (статус: idea/planned/doing/done/dropped).
- **Итоги сессии/обсуждения** → запись в `docs/CHATLOG_RU.md` (цель → что сделали → решения → что обновили → следующие шаги).
- **Архитектурное решение/инвариант** → отдельный ADR в `docs/adr/` (или обновление статуса существующего).

Минимальный DoD для любого патча:
- изменения включены в pack;
- обновлён `CHANGELOG.md`;
- обновлён `docs/CHATLOG_RU.md`, если был смысловой сдвиг/процесс/инфра;
- обновлены `История изменений` в затронутых “живых” документах (если их трогали);
- ADR добавлен/обновлён, если менялась архитектура/инварианты.


## История изменений
| Дата/время (MSK) | Автор | Тип | Кратко | Commit/PR |
|---|---|---|---|---|
| 2026-02-07 17:59 MSK | ChatGPT | docs | Зафиксировано: pack всегда сопровождается готовым блоком команд (каноничные пути + имя файла + commit message) | |
| 2026-02-07 16:25 MSK | ChatGPT | docs | Убрана рекомендация cherry-pick, шаблон применения pack вынесен в отдельный файл как единственный источник истины | |
| 2026-02-07 14:02 MSK | ChatGPT | doc | Уточнён шаблон применения паков (docker/pytest optional) и добавлена процедура удаления лишних веток (строго только main) | |
| 2026-02-07 12:00 MSK | ChatGPT | doc | Уточнён обязательный формат PRE-FLIGHT (что подключить/загрузить/нужен ли интернет) | |
| 2026-02-06 12:45 MSK | ChatGPT | doc | Добавлены правила фиксации изменений/идей/решений и обновлён порядок работы с внешними фактами | |
| 2026-02-05 03:00 MSK | ChatGPT | doc | Сформирован контракт процесса (пакеты, коммиты, Source of Truth) | |

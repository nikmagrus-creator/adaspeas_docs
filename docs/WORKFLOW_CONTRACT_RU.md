# WORKFLOW_CONTRACT (RU): правила работы с проектом в чате и через репозиторий

Актуально на: 2026-02-04 18:00 UTC

Цель: чтобы новый чат/ИИ мог работать с проектом без уточнений, без “мусора” в истории, и чтобы VPS обновлялась строго через репозиторий.

## 0) Каноничные настройки окружения (по умолчанию)
Source of Truth для работы из чата (всегда начинать отсюда):
- https://github.com/nikmagrus-creator/adaspeas_docs

Пути (не обсуждаются, их не “угадывают”):
- Локальная машина (Linux Mint), репозиторий проекта: `/home/nik/projects/adaspeas`
- Локальная папка загрузок архивов: `/media/nik/0C30B3CF30B3BE50/Загрузки`
- VPS директория проекта: `/opt/adaspeas`

Прочее:
- Ветка по умолчанию: `main`
- Основная папка каталога на Яндекс.Диске: `Zkvpr` (не `Adaspeas`)

## 0.1) Золотое правило деплоя (обязательно)
- VPS обновляется только через репозиторий (CI/CD).
- Ручные изменения на VPS запрещены. Любая правка: commit + push в репозиторий, дальше всё делает автоматический деплой.

## 1) Source-of-Truth и вложения
- Репозиторий GitHub является источником правды.
- Вложения в чат считать потенциально устаревшими.
- Если есть сомнения, что вложение актуально (или оно “не совпадает” с репозиторием) — требовать актуальный архив/файл в чат и сверять.

## 2) Anti-spam: что нельзя/можно писать в чат
Нельзя публиковать в чат:
- простыни кода/конфигов/диффов
- полные файлы (кроме коротких фрагментов, если это прямо нужно для обсуждения)

Можно и нужно:
- план работ, список затрагиваемых файлов
- риски/миграции/что будет удалено
- итоговое краткое резюме
- один минималистичный блок команд для применения пакета (см. §3)

## 3) Формат поставки изменений (обязательный протокол)
Любая правка поставляется так:
1) Инкрементальный архив (только изменённые/добавленные файлы и нужная структура каталогов)
2) Сразу после архива — один блок команд: применить → при необходимости удалить → commit → push

### 3.1) Требования к инкрементальному архиву
- Архив содержит только то, что меняется. Не “весь проект”.
- Пути внутри архива должны быть относительно корня репозитория (например, `docs/...`, `src/...`).
- Архив не должен добавлять лишний верхний каталог. (То есть при распаковке не появляется `project/` внутри репо.)
- Если нужно удалить файлы/папки, архив сам это не делает: создаётся список удалений `.pack/deleted.txt` (относительные пути), и команды удаляют их до/после распаковки.

### 3.2) Формат архива
Базовый формат: `tar.gz`.

Допускается `zip`, но команды распаковки тогда должны использовать `bsdtar` (потому что `unzip` не умеет нормально “снимать верхний каталог”, а ловушки людям нравятся).

## 4) Команды применения пакета (правила)
Команды должны быть:
- минималистичными и эффективными
- безопасными: проверка “repo clean” до применения
- без `set -e` и без `exit` (в некоторых терминалах/муляторах окно закрывается при ошибке)

Если в пакете есть удаления:
- удалять сразу в командах (например, `rm -rf ...` или по `.pack/deleted.txt`)

## 5) Дисциплина файлов
- Запрещено плодить новые файлы, если можно обновить существующие.
- Новый файл допускается только если:
  1) появляется новый тип артефакта (INDEX/CONTRACT/CHANGELOG/ADR и т.п.), или
  2) существующий документ перестал быть читаемым (смешал разные цели).
- Если создан новый файл: обязателен апдейт `docs/INDEX_RU.md` и запись причины в “Истории изменений” соответствующего документа.

## 6) Дисциплина документов (дата/история)
Если меняется смысл документа (не опечатка):
- обновить строку `Актуально на: YYYY-MM-DD HH:MM UTC`
- добавить запись в таблицу “История изменений” в этом же документе

Если меняется публичный контракт/поведение системы:
- дополнительно обновить `CHANGELOG.md` (если он в этом репозитории) или соответствующий релизный журнал

## 7) Мини-checklist перед выдачей архива
Перед публикацией пакета убедиться:
- архив действительно инкрементальный (нет лишних файлов)
- пути внутри архива относительные и корректные
- команды применения удаляют лишнее (если требуется)
- повторное применение пакета не ломает репозиторий (идемпотентность насколько возможно)

## История изменений
| Дата/время (UTC) | Автор | Тип | Кратко | Commit/PR |
|---|---|---|---|---|
| 2026-02-04 12:00 UTC | ChatGPT | contract | Зафиксирован протокол работы “архив + команды”, запрет мусора, дисциплина файлов и истории | |
| 2026-02-04 13:45 UTC | ChatGPT | contract | Уточнено: всегда начинать с GitHub docs-репозитория; вложения считать потенциально устаревшими | |
| 2026-02-04 14:30 UTC | ChatGPT | doc | Зафиксированы каноничные пути (local/VPS) и запрет ручных правок на VPS | |
| 2026-02-04 18:00 UTC | ChatGPT | contract | Переписан контракт: инкрементальные пакеты, список удалений, минимальные команды без set -e/exit | |

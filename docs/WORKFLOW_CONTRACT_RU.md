# WORKFLOW CONTRACT (RU)

Этот документ задаёт правила работы. В спорных случаях этот контракт важнее чата, памяти и вложений.


## 0) Source of Truth и окружение (обязательные по умолчанию)

- Часовой пояс по умолчанию для планирования и формулировок “сегодня/завтра”: **Europe/Moscow (MSK)**.
- Таймстемпы в документах/чатлоге: **MSK (UTC+3)**.

Source of Truth для документации:
- GitHub-репозиторий: https://github.com/nikmagrus-creator/adaspeas_docs
- Вложения/архивы из чата считать потенциально устаревшими. При любом сомнении требуется актуальный архив или ссылка на текущий commit.
- Ветка по умолчанию: `main`.

Каноничные пути (раз и навсегда):
- Local (Linux Mint), репозиторий: `/home/nik/projects/adaspeas`
- Папка скачивания паков: `/media/nik/0C30B3CF30B3BE50/Загрузки`
- VPS директория проекта: `/opt/adaspeas`

Хранилище (если используется Яндекс.Диск):
- Корневая папка каталога: `Zkvpr` (не `Adaspeas`).
- В интерфейсе бота название внешнего хранилища и внутренние пути **не показываем**.


## 0.1) Золотое правило деплоя

- VPS обновляется **только** через репозиторий и CI/CD. Ручные изменения на VPS запрещены.
- Любые изменения: локально → `git commit` → `git push` → CI применяет на VPS.


## 0.2) Если GitHub/remote недоступен (trade controls / блокировки)

Случаи, когда GitHub временно недоступен (DNS/сеть, trade controls, санкции), считаются нормальным внешним риском.

Правила:
- Коммиты делаем локально как обычно, история не теряется.
- Держим fallback remote (зеркало) на альтернативном хостинге (Codeberg/GitLab/self-hosted Gitea).
- Временный перевод репозитория в public допустим только как вынужденная мера:
  - секреты/ключи/токены в git запрещены;
  - факт и причина фиксируются в `docs/CHATLOG_RU.md` (дата/время MSK + план возврата).


## 1) Документация: структура, приоритет, запреты

Порядок чтения и обновления:
1) `docs/INDEX_RU.md`
2) `docs/WORKFLOW_CONTRACT_RU.md`
3) `docs/CHATLOG_RU.md`
4) `docs/adr/`

Назначение документов:
- `INDEX_RU.md` — точка входа и карта документации.
- `PRD_RU.md` — что строим и зачем (продуктовые требования).
- `TECH_SPEC_RU.md` — как устроено (архитектура и контракты компонентов).
- `OPS_RUNBOOK_RU.md` — как запускать/обслуживать/чинить.
- `ROADMAP_RU.md` — приоритеты и этапы.
- `CHATLOG_RU.md` — итоги сессий и короткие фиксации изменений.
- `adr/` — отдельные архитектурные решения (ADR).

Запрет на «плодить файлы»:
- Новые файлы/доки добавляем **только** когда появляется новый тип артефакта, которого раньше не было.
- Если тип артефакта уже существует, **обновляем существующий документ**, а не создаём “ещё один файл правил”.
- Исключение: новый ADR допустим, когда принято значимое решение и его нужно зафиксировать отдельно.


## 2) Изменения только пакетами (incremental pack)

Любые изменения в репозитории передаются и применяются только через **.tar.gz пакет**, который распаковывается в корень репозитория.

Пакет может содержать:
- изменённые файлы;
- новые файлы (только если это разрешено правилами раздела 1);
- служебную папку `.pack/`:
  - `.pack/deleted.txt` — список путей для удаления (по одному пути в строке).

После применения пакета папка `.pack` удаляется.


## 2.1) Каноничный шаблон применения пакета

Ниже шаблон команд. Он короткий, безопасный, не использует `set -e`/`exit`, поддерживает `.pack/deleted.txt`.

```bash
cd /home/nik/projects/adaspeas &&

test -d .git || { echo "No .git here (clone repo first)"; false; } &&

test -z "$(git status --porcelain)" || { echo "Repo dirty. Commit/stash first."; false; } &&

PACK="/media/nik/0C30B3CF30B3BE50/Загрузки/<PACK_NAME>.tar.gz" &&

test -f "$PACK" || { echo "Pack not found: $PACK"; false; } &&

tar -xzf "$PACK" -C . &&

if test -f .pack/deleted.txt; then
  while IFS= read -r p; do
    test -n "$p" || continue
    git rm -r --ignore-unmatch "$p" >/dev/null 2>&1 || rm -rf "$p"
  done < .pack/deleted.txt
fi &&

rm -rf .pack &&

git add -A &&

git commit -m "<типы: docs|feat|fix|refactor|ops|chore|test>: <сообщение по-русски>" &&

git push
```


## 3) Коммиты: только по-русски

Требование: сообщения коммитов пишем **только на русском**.

Рекомендуемый формат:
- Одна строка: `<тип>: <кратко, русскими словами>`
- Типы: `docs`, `feat`, `fix`, `refactor`, `ops`, `chore`, `test`.
- Без точки в конце строки.
- Желательно ≤ 72 символов (не критично, но удобно).
- Если нужен подробный контекст, добавляется тело коммита (тоже по-русски).

Примеры:
- `docs: зафиксировать полную спецификацию связки Telegram + Диск + VPS`
- `feat: добавить inline-навигацию каталога и кнопку Назад`
- `fix: не показывать пользователю внутренние названия хранилища`


## 4) Правила общения в чате разработки

- В чате пишем минимум: что сделано, что в пакете, какую команду применить, какой коммит.
- Команды не “обсуждаем”, а выдаём в одном каноничном блоке (раздел 2.1).
- Если нужно поменять правило, оно меняется в этом контракте и фиксируется в `docs/CHATLOG_RU.md`.
## 4.1) Выбор источника для работы (GitHub / архив / внешние факты)

Перед началом любой задачи ассистент явно пишет, в каком режиме работаем и что требуется предоставить/включить.

Правило выбора:
- **Проверить / сверить / исправить по текущему `main`** → нужен **GitHub-коннектор** (это Source of Truth).
- **Сделать большие правки и не зависеть от состояния GitHub** → нужен **полный архив репозитория** или **инкрементальный pack** (актуальный).
- **Нужны точные внешние факты** (лимиты, API, регламенты, изменения у провайдеров) → нужны **источники от пользователя**: ссылка/выдержка/файл. Без источника это считается предположением.

Если есть расхождение между архивом и `main`, приоритет у `main` (раздел 0: Source of Truth).

# CHATLOG (RU): итоги сессий и память чатов

Актуально на: 2026-02-07 17:59 MSK

Примечание про время: время записей и история фиксируются в **MSK (Europe/Moscow, UTC+3)**.

Правило: если в чате появилось полезное правило/решение/изменение планов, оно должно быть:
- зафиксировано здесь (итоги), и
- отражено в ADR/CHANGELOG/живых документах, если применимо (см. `docs/WORKFLOW_CONTRACT_RU.md`).

## Формат записи
- Дата/время (MSK)
- Цель
- Что сделано (кратко)
- Решения (ADR ссылки)
- Документы обновлены (INDEX/CONTRACT/PRD/TECH/OPS/CHANGELOG)
- Следующие шаги

## Журнал

### 2026-02-04 03:00 MSK
Цель: поднять базовый контур документации и процесса работы “архив + команды”.

Что сделано:
- Введён единый вход `docs/INDEX_RU.md`
- Зафиксирован процесс `docs/WORKFLOW_CONTRACT_RU.md`
- Добавлены/уточнены PRD/TECH/OPS, шаблон ADR, CHANGELOG, PATCH_REPORT

Решения:
- Структура документации разделена по назначению (INDEX/CONTRACT/PRD/TECH/OPS + ADR + CHANGELOG)

Документы обновлены:
- INDEX/CONTRACT/PRD/TECH/OPS/CHANGELOG (+ PATCH_REPORT)

Следующие шаги:
- Уточнить контракт под автономную разработку ассистентом и закрепить правила памяти проекта (CHATLOG/ADR).

### 2026-02-05 03:00 MSK
Цель: перестроить процесс под автономную разработку ассистентом и закрепить память проекта.

Что сделано:
- Переписан `docs/WORKFLOW_CONTRACT_RU.md`: добавлены правила CHATLOG/ADR/CHANGELOG, инкрементальные пакеты, требования к командам (VTE-friendly).
- Обновлён `docs/INDEX_RU.md`: добавлен CHATLOG.
- Приведён ADR template к обязательным полям (MSK/Status/Context/Decision/Consequences).
- Обновлён CI docs-policy: разрешён `docs/CHATLOG_RU.md`.

Решения:
- Память проекта ведётся через: `docs/CHATLOG_RU.md` (итоги), `docs/adr/` (решения), `CHANGELOG.md` (изменения).

Документы обновлены:
- INDEX/CONTRACT/ADR template/CI policy/CHANGELOG

Следующие шаги:
- Переписать содержательно PRD/TECH/OPS по текущему коду (и синхронизировать с реальным состоянием).
## 2026-02-05: CI/infra стабилизация (smoke, .env, deps, trade-controls)

Контекст: несколько подряд красных прогонов GitHub Actions из‑за ошибок в workflow YAML, guard для `.env`, требований CI к наличию `.env`, падения Trivy (CVE), конфликтов зависимостей aiogram/aiohttp и нестабильного smoke‑health (бот падал при фейковом токене).

Что сделано (итоги):
- `deploy.yml`: вычищены ошибки YAML и сделан стабильный pipeline.
- Guard для `.env`: запрещаем трекать `.env` и `.env.*`, **кроме** `.env.example` (он должен оставаться в git).
- `ci-smoke`: перед `docker compose config` создаём `.env` из `.env.example` (CI не держит секреты в репо).
- Trivy: устранён HIGH по `aiohttp` (обновление зависимости). 
- Smoke health: бот больше не умирает при фейковом токене в CI (иначе `get_me` падает с Unauthorized и контейнер рестартится).
- SQLite/локальное хранилище: пути сделаны smoke‑safe (используем `/tmp/...` в CI, чтобы не упираться в права/отсутствующие директории).
- GitHub trade-controls: зафиксировано, что remote может быть временно недоступен; на период ограничений репозиторий был переключён в public как временная мера.

Примечания:
- Старые красные workflow‑раны остаются в истории как “failed” для тех SHA. Это нормально: корректность подтверждает **последний зелёный** прогон. При необходимости старые раны можно “Re-run” вручную (см. docs GitHub Actions).

### 2026-02-06 00:40 MSK
Цель: убрать “мины” в living docs, чтобы будущие правки не валили CI.

Что сделано:
- `docs/PRD_RU.md`: добавлена секция `## История изменений` с первой строкой (MSK).
- `docs/DOCS_RATIONALE_RU.md`: история изменений приведена к единому формату (добавлены Автор/Commit/PR и MSK в строках).

Решения:
- Живые документы должны быть CI‑готовы заранее, даже если их не трогали в текущем патче.

Документы обновлены:
- PRD/DOCS_RATIONALE/CHATLOG


### 2026-02-06 01:15 MSK
Цель: стабилизировать деплой и подготовить базу под “библиотеку” (VPS + Яндекс.Диск + Telegram).

Что сделано:
- Починен деплой: контейнеры bot/worker падали из‑за `sqlite3.OperationalError: attempt to write a readonly database` (права на volume). Введена инициализация прав на data volume.
- Локальный Telegram Bot API сервер добавлен как опция инфраструктуры (для файлов >50MB и снижения ограничений cloud Bot API).
- Подготовлены предпосылки для кэша Telegram `file_id` (ускорение повторных скачиваний без повторной загрузки с Диска).
- Зафиксировано правило переезда в новый чат: старт через `docs/INDEX_RU.md`, без копипаста “контрактов” в переписку.

Решения:
- Локальный Bot API server рассматривается как базовый фундамент для “библиотеки”, если в каталоге есть файлы >50MB.

Документы обновлены:
- INDEX/CHATLOG.

Следующие шаги:
- Inline‑каталог (кнопки, назад, страницы) + перенос синхронизации каталога в фон (SQLite как кэш).
- После UI: модель доступа (30 дней по умолчанию, ручное продление админом) и аудит скачиваний.
### 2026-02-06 12:45 MSK
Цель: закрыть коллизии между кодом/доками и закрепить дисциплину фиксации изменений/идей.

Что сделано:
- Починен fallback порт Local Bot API в bot/worker (8081 вместо 8082).
- Деплой: добавлена логика автоподъёма Compose profile `localbotapi`, если `USE_LOCAL_BOT_API=1` + проверка `TELEGRAM_API_ID/HASH`.
- CI: добавлен guard “изменил код/инфру → обнови CHANGELOG или CHATLOG”.
- Документация синхронизирована с реальными env‑именами из `.env.example` (TECH/OPS/CONTRACT/ROADMAP).

Решения:
- ADR-002 переведён в Accepted (Local Bot API как базовый компонент для файлов > 50 MB).
- ADR-003: фиксация изменений/идей/решений через CHANGELOG/CHATLOG/ROADMAP/ADR.

Документы обновлены:
- WORKFLOW_CONTRACT/TECH_SPEC/OPS_RUNBOOK/ROADMAP/CHANGELOG/CHATLOG/ADR-002/ADR-003 + PR template + deploy workflow.

Следующие шаги:
- Inline‑каталог (кнопки, назад, страницы).
- Перенос синхронизации каталога в фон (worker schedule + метка “обновлено …”).
- Модель доступа (pending/active/expired) + уведомления и аудит скачиваний.
- e2e/ручной runbook тест на файл > 50 MB через Local Bot API.


### 2026-02-07 12:00 MSK
Цель: довести “идеальность” процесса: обязателен PRE-FLIGHT, убрать остаточные коллизии, уточнить метрики и админ‑оповещения.

Что сделано:
- Закреплён фиксированный формат PRE-FLIGHT (что подключить/загрузить, нужен ли интернет, что будет результатом).
- Уточнены админ‑оповещения: отдельный админ‑чат/топик как план, без фиктивных env-имен.
- Добавлена эксплуатационная заметка по /metrics и Basic Auth: пароль в Caddy только хэш (hash-password).

Решения:
- Без новых ADR (уточнение процесса без изменения архитектурных инвариантов).

Документы обновлены:
- INDEX/WORKFLOW_CONTRACT/OPS_RUNBOOK/ROADMAP/CHANGELOG/CHATLOG + PR template + deploy workflow + env.example + Caddyfile.

Следующие шаги:
- Inline‑каталог (кнопки, назад, страницы) и перенос синка в фон (SQLite кэш).

### 2026-02-07 12:55 MSK
Цель: закрыть инцидент SQLite readonly на VPS и убрать повторяемость.

Что сделано:
- Причина подтверждена: Docker может создать bind-mount директорию `./data` как `root:root`, а контейнеры работают под UID/GID приложения → WAL не может создать `*.db-wal/*.db-shm`.
- В `docker-compose.yml` добавлен one-shot `init-app-data` и зависимости `bot/worker` от его успешного завершения.
- В `docker-compose.prod.yml` `init-app-data` сделан one-shot (без `sleep infinity`) и `bot/worker` ждут завершения.
- OPS/README обновлены: на VPS использовать `docker-compose.prod.yml`/systemd unit.
- Добавлен ADR-004 (инициализация прав на /data).

Решения:
- Основные сервисы остаются non-root; права на /data обеспечиваются отдельным init контейнером.

Документы обновлены:
- CHANGELOG, OPS_RUNBOOK, README, ADR-004, CHATLOG.

Следующие шаги:
- На VPS деплоить патч через git (CI/CD), затем можно удалить ручной chown (если он был сделан).
### 2026-02-07 13:55 MSK
Цель: закрепить “readonly database” фикс в документации и сделать восстановление максимально простым.

Что сделано:
- Процесс: закреплено правило "одна ветка main"; обновлён шаблон применения паков (pull --ff-only, push origin main).
- Подтверждена практикой аварийная команда на VPS: разовый `chown` внутри контейнера от root действительно снимает `sqlite3.OperationalError: attempt to write a readonly database`.
- Документация усилена: README/TECH/OPS теперь явно описывают контракт `/data` (WAL требует записи) и механизм `init-app-data` как норма.
- Добавлены удобные цели Makefile: `make fix-data-perms` и `make fix-data-perms-prod` (запуск one-shot `init-app-data` вручную).
- В `.env.example` добавлены `APP_UID/APP_GID` (для prod compose, по умолчанию 1000:1000).

Решения:
- ADR-004 остаётся актуальным (Accepted): non-root сервисы + one-shot init для прав на /data.

Документы обновлены:
- README, TECH_SPEC, OPS_RUNBOOK, PACK_APPLY_TEMPLATE, .env.example, Makefile, CHATLOG, CHANGELOG.

Следующие шаги:
- Деплоить через git (CI/CD) на VPS /opt/adaspeas и больше не лечить права руками, кроме аварийных случаев.
### 2026-02-07 14:02 MSK
Цель: довести правило “только main” до состояния, где оно не ломается от автоматики и человеческой самодеятельности.

Что сделано:
- Удалён Dependabot-конфиг (`.github/dependabot.yml`), чтобы GitHub больше не создавал ветки `dependabot/*`.
- Удалён PR template (`.github/pull_request_template.md`), потому что PR подразумевают ветки, а у нас это запрещено.
- В WORKFLOW_CONTRACT добавлена процедура чистки origin/локальных refs: удалить всё кроме `main`.
- В OPS_RUNBOOK добавлена операционная процедура “как быстро убрать лишние ветки”.

Решения:
- Нулевая терпимость к веткам: если ветка появилась, её удаляем, а изменения переносим в `main` через pack (без cherry-pick).

Документы обновлены:
- WORKFLOW_CONTRACT, OPS_RUNBOOK, PACK_APPLY_TEMPLATE, README, CHANGELOG, CHATLOG.

Следующие шаги:
- На GitHub удалить существующие лишние ветки (например `ops/*`, `dependabot/*`) и убедиться, что на origin осталась только `main`.

### 2026-02-07 15:35 MSK
Цель: убрать последствия случайного `git cherry-pick` и сделать процесс “только main” самодостаточным.

Что случилось:
- Попытка cherry-pick старого коммита поверх актуального `main` дала конфликты в доках (состояние `needs merge`).

Как лечить:
- Отменять незавершённые операции (`git cherry-pick --abort` / `git merge --abort`) и возвращаться к `origin/main`.

Что улучшено:
- В `docs/PACK_APPLY_TEMPLATE_RU.md` добавлены явные проверки на незавершённый merge/cherry-pick и принудительное `git checkout main`.
- Добавлено напоминание, что pack не должен содержать `.git/`.



### 2026-02-07 16:20 MSK
Цель: добить репо-гигиену (только `.env.example` в git) и убрать причину CI-фейлов.

Что изменено:
- Политика: **не используем** `merge/cherry-pick/rebase` вообще. Если ветка появилась или что-то зависло в конфликтном состоянии, возвращаемся к `origin/main` и повторяем изменения через pack.
- `docs/PACK_APPLY_TEMPLATE_RU.md`: добавлен безопасный пролог (abort + проверка локальных коммитов + `git reset --hard origin/main`) и защита от пустого коммита.
- CI (workflow): проверка `.env` теперь однозначная: `.env.example` обязателен, любые другие `.env*` в git запрещены; добавлен вывод списка трекнутых env-подобных файлов для отладки.

Важное замечание:
- Нельзя делать `git rm --cached -f .env.*` вслепую: это удалит и `.env.example`. Если нужно убрать лишние `.env*`, удаляем всё кроме `.env.example`.

### 2026-02-07 17:10 MSK
Цель: закрепить «production-safe» значения в `.env.example` и зафиксировать решение про одну ветку.

Что улучшено:
- `.env.example`: нормальные дефолты `SQLITE_PATH=/data/app.db`, `LOCAL_STORAGE_ROOT=/data/storage`, `CI_SMOKE=0`.
- `docs/TECH_SPEC_RU.md`: добавлены рекомендованные значения и объяснение почему `/data` (SQLite WAL).
- Добавлен ADR-005 (только `main` + repo hygiene env).

Замечание по артефактам:
- Полные архивы/zip, присылаемые для анализа, тоже **не должны** включать `.git/` (для этого у нас есть pack-механика).

### 2026-02-07 17:59 MSK
Цель: убрать “угадайку” после выдачи pack и сделать применение полностью copy‑paste.

Что сделано:
- В `docs/INDEX_RU.md` и `docs/WORKFLOW_CONTRACT_RU.md` закреплено правило: **если выдан pack**, то в том же сообщении выдаётся **готовый** блок команд (каноничные пути + имя файла пакета + commit message).
- В `docs/PACK_APPLY_TEMPLATE_RU.md` добавлена пометка, что шаблон предназначен для прямой вставки в ответ ассистента.

Решения:
- Без новых ADR (процесс уточнён без изменения архитектурных инвариантов).

Документы обновлены:
- INDEX/WORKFLOW_CONTRACT/PACK_APPLY_TEMPLATE/CHATLOG.

Следующие шаги:
- Держать команды применения pack строго по шаблону (все улучшения вносить в `docs/PACK_APPLY_TEMPLATE_RU.md`).


### 2026-02-07 18:30 MSK
Цель: реализовать UX каталога через inline‑навигацию (папки/файлы кнопками) без длинных `callback_data`.

Что сделано:
- В SQLite добавлен указатель на родителя `parent_path` (миграция v3) для построения дерева и кнопки “Назад”.
- Бот: `/categories` теперь показывает каталог через inline‑кнопки и редактирует одно сообщение; файлы ставят job через `dl:<id>`.
- Навигация реализована как **lazy‑sync** по текущей папке: при открытии папки бот делает `list_dir(path)` в хранилище и upsert’ит детей в SQLite.
- Добавлен ADR-006 про выбор `parent_path` и числовых id в callback.

Документы обновлены:
- `docs/TECH_SPEC_RU.md` и `docs/ROADMAP_RU.md`.

Следующие шаги:
- Milestone 1 / пункт 3: фоновая синхронизация каталога (worker + last_sync метка), чтобы UI мог работать только по SQLite без обращений в хранилище.


### 2026-02-07 19:40 MSK
Цель: сделать UI независимым от хранилища и перевести синхронизацию каталога в background worker.

Что сделано:
- SQLite schema v4:
  - `jobs.job_type` (по умолчанию `download`, добавлен `sync_catalog`);
  - таблица `meta` и ключ `catalog_last_sync_at`.
- Worker: добавлен обработчик `job_type=sync_catalog`.
  - рекурсивный обход дерева от `YANDEX_BASE_PATH` (или `/` в local) через `list_dir`;
  - upsert элементов в `catalog_items` с `parent_path=<path>`;
  - запись `catalog_last_sync_at` (UTC ISO).
- Bot:
  - `/categories` и `nav:<id>` читают только SQLite (в хранилище не ходят);
  - команда `/sync` (admin) ставит `sync_catalog` job в очередь;
  - UI показывает метку “обновлено …” (если есть).
- Добавлен ADR-007 (фоновой sync).

Следующие шаги:
- Сделать периодический sync по расписанию (interval в worker или отдельный scheduler).
- Добавить обработку удалений (soft‑delete или реальное удаление из SQLite).
- Для больших деревьев: пагинация (`limit/offset`) на стороне хранилища и ограничение глубины/количества узлов.


### 2026-02-07 20:10 MSK
Цель: закрыть “next steps” после фонового sync: расписание, удаления, пагинация UI.

Что сделано:
- SQLite schema v5:
  - `catalog_items.seen_at` (последний раз увидели в sync),
  - `catalog_items.is_deleted` (soft-delete),
  - индекс `idx_catalog_deleted_parent`.
- Worker:
  - `sync_catalog` теперь после обхода помечает “неувиденные” элементы как `is_deleted=1` (чтобы не было “призраков”).
  - добавлен внутренний scheduler, который периодически ставит `sync_catalog` job в очередь при `CATALOG_SYNC_INTERVAL_SEC>0`.
  - пишется meta `catalog_last_sync_deleted`.
- Bot:
  - `/categories` и `nav:<id>[:<page>]` поддерживают пагинацию (`CATALOG_PAGE_SIZE`) и показывают “Удалено: ...” рядом с “Обновлено: ...”.

Документы обновлены:
- `docs/TECH_SPEC_RU.md`, `docs/ROADMAP_RU.md`, `docs/OPS_RUNBOOK_RU.md`, `docs/WORKFLOW_CONTRACT_RU.md`.

Следующие шаги:
- (по желанию) поиск по каталогу (IDEA-007).
- (по желанию) перенос “меток времени” на MSK в UI (сейчас показываем как есть).

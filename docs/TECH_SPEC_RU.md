# Техническая спецификация: Adaspeas (консолидировано)

Актуально на: 2026-02-04 12:00 UTC

Цель: один источник правды по устройству системы и публичным контрактам. Ops-процедуры — в `docs/OPS_RUNBOOK_RU.md`.

## 1) Компоненты
- `bot` (aiohttp): принимает запросы, создаёт/обновляет job, публикует job_id в очередь.
- `worker`: забирает job_id из очереди, выполняет job, пишет статус/результат.
- `redis`: транспорт очереди/временное состояние.
- `caddy`: TLS + reverse proxy + Basic Auth на `/metrics`.

## 2) Порты и маршрутизация
Внутри docker-сети:
- bot: `8080`
- worker: `8081`
- redis: `6379`

Наружу:
- 80/443 → `caddy`
- `caddy` проксирует запросы к bot (и при необходимости к worker).

## 3) Public contracts (MUST/SHOULD)
Эти контракты считаются “публичными” и не меняются случайно.

HTTP:
- `GET /health` **MUST** возвращать 200 и JSON `{"ok": true}`.
- `GET /metrics` **MUST** быть доступен локально; в проде **SHOULD** быть закрыт Basic Auth на уровне Caddy.
- `GET /` **SHOULD** редиректить на `/health` (Caddy).

Данные:
- SQLite **MUST** быть Source of Truth.
- Продовый путь БД **SHOULD** быть `/data/app.db` (volume `app_data`).
- Redis **MUST NOT** считаться источником истины.

Очередь и обработка:
- Очередь переносит `job_id`, а не “большие payload”.
- Worker **MUST** быть идемпотентным.
- Retry **MUST NOT** превышать 3 попытки.

## 4) Наблюдаемость
- `health` обязателен и максимально простой (для curl).
- `metrics` обязателен для отладки/наблюдения.

## 5) Инварианты
- Секреты только в `.env` на VPS и GitHub Secrets.
- Никаких ручных правок на VPS кроме `.env` (иначе git перестаёт быть источником истины).
- Конфиги деплоя/прокси/compose версионируются в git.

## История изменений
| Дата/время (UTC) | Автор | Тип | Кратко | Commit/PR |
|---|---|---|---|---|
| 2026-02-04 12:00 UTC | ChatGPT | doc | Выделены публичные контракты в стиле MUST/SHOULD | |

# Техническая спецификация: Adaspeas (консолидировано)

Актуально на: 2026-02-04 00:00 UTC

Цель: описать устройство системы и инженерные контракты в одном месте. Ops-инструкции (деплой/перенос/секреты) — в `docs/OPS_RUNBOOK_RU.md`.

## 1) Компоненты
- `bot` (aiohttp): принимает запросы пользователей, создаёт/обновляет job, публикует job_id в очередь.
- `worker`: забирает job_id из очереди, выполняет job, пишет статус/результат.
- `redis`: транспорт очереди/временное состояние.
- `caddy`: TLS + reverse proxy + Basic Auth на `/metrics`.

## 2) Порты и маршрутизация
Внутри docker-сети:
- bot: `8080`
- worker: `8081`
- redis: `6379`

Наружу:
- 80/443 → `caddy`
- `caddy` проксирует запросы к bot (и при необходимости к worker).

HTTP:
- `/health` → 200 `{"ok": true}`
- `/metrics` → метрики; в проде закрыты Basic Auth на уровне Caddy
- `/` → 302 на `/health` (правило Caddy)

## 3) Данные
- SQLite — источник истины.
- Продовый путь БД: `/data/app.db` (в volume `app_data`).
- Redis данные не считаются “истиной” и могут быть восстановлены.

## 4) Очередь и обработка задач
- Единица работы: job (идентификатор job_id).
- Очередь переносит job_id (не “сырой большой payload”).
- Worker:
  - идемпотентность обязательна
  - retry ≤ 3
  - запись состояния/результата в SQLite

## 5) Наблюдаемость
- `health` обязателен и максимально тупой (для curl).
- `metrics` присутствует и защищён (prod) Basic Auth.

## 6) Инварианты
- Секреты только в `.env` на VPS и GitHub Secrets.
- Никаких ручных правок на VPS кроме `.env` (иначе репо перестаёт быть источником истины).
- Конфиги деплоя/прокси/compose версионируются в git.

## История изменений
| Дата/время (UTC) | Автор | Тип | Кратко что изменили | Причина/ссылка | Commit/PR |
|---|---|---|---|---|---|
| 2026-02-04 00:00 UTC | ChatGPT | doc | Консолидация техдоков в TECH_SPEC_RU.md | сокращение документации | |

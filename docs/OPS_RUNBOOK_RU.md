# OPS_RUNBOOK (RU): эксплуатация, инциденты, обслуживание

Актуально на: 2026-02-06 00:10 MSK

Этот документ отвечает на вопрос “что делать, когда оно уже работает на VPS и внезапно перестало”. Архитектурные контракты см. в `docs/TECH_SPEC_RU.md`, процесс — в `docs/WORKFLOW_CONTRACT_RU.md`.


## 1) Компоненты в проде

Ожидаемые сервисы:
- bot (aiogram): обрабатывает Telegram апдейты, отдаёт UI.
- worker: выполняет фоновые задачи (доставка файлов, синхронизация, уведомления).
- redis: очередь.
- sqlite (файл): каталог/пользователи/аудит.
- (рекомендуется) telegram-bot-api: Local Bot API Server в режиме `--local`.

Внешние зависимости:
- Telegram (клиенты, сервера).
- Яндекс.Диск (источник файлов).


## 2) Первые 90 секунд при инциденте

1) Проверить, живы ли контейнеры (`docker compose ps`).
2) Проверить логи bot/worker (ошибки 401/403/429, таймауты, падения).
3) Если массовые 429/таймауты — временно выключить шумные задачи (уведомления/синхронизацию), оставив базовый UI.
4) Если сломалась доставка файлов — фиксировать ошибку в аудит и уведомить админа в `ADMIN_CHAT_ID`.


## 3) Local Bot API Server (telegram-bot-api)

Зачем нужен:
- стандартный Bot API ограничивает отправку файлов ботом 50 MB; Local Bot API Server в режиме `--local` поднимает лимит загрузки до 2000 MB и снимает лимит на скачивание файлов (практически до тех же 2 GB).

Что важно в эксплуатации:
- для запуска нужны `TELEGRAM_API_ID` и `TELEGRAM_API_HASH` (получаются в Telegram).
- сервис должен быть доступен только внутри docker-сети (не выставлять наружу без нужды).
- данные tdlib (сессии/кэш) должны жить в volume, иначе при пересоздании контейнера будут сюрпризы.

Минимальная проверка:
- bot/worker должны ходить не на `https://api.telegram.org`, а на `LOCAL_BOT_API_URL`.
- при проблемах сначала смотреть логи `telegram-bot-api`.


## 4) Яндекс.Диск

Типичные проблемы:
- 401/403: токен истёк/отозван.
- 429: слишком частые запросы (нужна пауза/бэк‑офф).
- “неполный каталог”: нет пагинации по `limit/offset`.

Правила:
- синхронизация каталога должна идти в фоне и с ограничением частоты.
- токен хранить только в env (`YD_OAUTH_TOKEN`), не в git.


## 5) Очереди и антифлуд

Симптомы:
- 429 Too Many Requests от Telegram.

Действия:
- снизить скорость рассылок (уведомления),
- включить очередь/троттлинг,
- для “массовых уведомлений” отправлять порциями.


## 6) Бэкапы

Минимум:
- SQLite файл (каталог/пользователи/аудит).
- (если используется) volume telegram-bot-api (tdlib data).

Периодичность зависит от критичности, но хотя бы раз в сутки.


## 7) Админ‑оповещения

Чтобы админ не “жил в личке с ботом”, используется отдельная цель:
- `ADMIN_CHAT_ID` (группа/канал)

Туда уходят:
- уведомления об истечении доступа,
- ошибки доставки файлов,
- ошибки синхронизации каталога.


## 8) Признаки деградации и что логировать

Логируем (внутри контейнеров и в БД в виде аудита):
- каждую попытку скачивания (ok/error + причина),
- время синхронизации каталога и число элементов,
- ошибки внешних API (Telegram/Yandex).

Это помогает отвечать на главный вопрос эксплуатации: “что сломалось и у кого”.

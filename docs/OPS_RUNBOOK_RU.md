# OPS_RUNBOOK (RU): эксплуатация, инциденты, обслуживание

Актуально на: 2026-02-07 12:00 MSK
Этот документ отвечает на вопрос “что делать, когда оно уже работает на VPS и внезапно перестало”. Архитектурные контракты см. в `docs/TECH_SPEC_RU.md`, процесс — в `docs/WORKFLOW_CONTRACT_RU.md`.


## 1) Компоненты в проде

Ожидаемые сервисы:
- bot (aiogram): обрабатывает Telegram апдейты, отдаёт UI.
- worker: выполняет фоновые задачи (доставка файлов, синхронизация, уведомления).
- redis: очередь.
- sqlite (файл): каталог/пользователи/аудит.
- (рекомендуется) local-bot-api: Local Bot API Server в режиме `--local`.

Внешние зависимости:
- Telegram (клиенты, сервера).
- Яндекс.Диск (источник файлов).


## 2) Первые 90 секунд при инциденте

1) Проверить, живы ли контейнеры (`docker compose ps`).
2) Проверить логи bot/worker (ошибки 401/403/429, таймауты, падения).
3) Если массовые 429/таймауты — временно выключить шумные задачи (уведомления/синхронизацию), оставив базовый UI.
4) Если сломалась доставка файлов — фиксировать ошибку в аудит и уведомить админов (как минимум: каждому из `ADMIN_USER_IDS`).


## 3) Local Bot API Server (local-bot-api)

Зачем нужен:
- стандартный Bot API ограничивает отправку файлов ботом 50 MB; Local Bot API Server в режиме `--local` поднимает лимит загрузки до 2000 MB и снимает лимит на скачивание файлов (практически до тех же 2 GB).

Что важно в эксплуатации:
- для запуска нужны `TELEGRAM_API_ID` и `TELEGRAM_API_HASH` (получаются в Telegram).
- сервис должен быть доступен только внутри docker-сети (не выставлять наружу без нужды).
- данные tdlib (сессии/кэш) должны жить в volume, иначе при пересоздании контейнера будут сюрпризы.

Минимальная проверка:
- В `.env` выставлен `USE_LOCAL_BOT_API=1` и корректный `LOCAL_BOT_API_BASE`.
- В Compose включён профиль `localbotapi` (например, `COMPOSE_PROFILES=localbotapi docker compose ... up -d`), и сервис `local-bot-api` запущен.
- bot/worker ходят не на `https://api.telegram.org`, а на `LOCAL_BOT_API_BASE`.
- при проблемах сначала смотреть логи `local-bot-api`.


## 3.1) Метрики (/metrics)

Метрики проксирует Caddy (см. `deploy/Caddyfile`) и защищает Basic Auth.

Важно: Caddy **не принимает plaintext пароли** в конфигурации Basic Auth. В `METRICS_PASS` нужно класть **вывод** команды:

```bash
caddy hash-password --plaintext "<пароль>"
```

Затем:
- `METRICS_USER` = логин,
- `METRICS_PASS` = хэш из `caddy hash-password`.

## 4) Яндекс.Диск

Типичные проблемы:
- 401/403: токен истёк/отозван.
- 429: слишком частые запросы (нужна пауза/бэк‑офф).

Правила:
- синхронизация каталога должна идти в фоне и с ограничением частоты.
- токен хранить только в env (`YANDEX_OAUTH_TOKEN`), не в git.
- `YANDEX_BASE_PATH` хранить в env и держать стабильным, иначе “переедут” пути каталога.


## 5) Очереди и антифлуд

Симптомы:
- 429 Too Many Requests от Telegram.

Действия:
- снизить скорость рассылок (уведомления),
- включить очередь/троттлинг,
- для “массовых уведомлений” отправлять порциями.


## 6) Бэкапы

Минимум:
- SQLite файл (каталог/пользователи/аудит).
- (если используется) volume local-bot-api (tdlib data).

Периодичность зависит от критичности, но хотя бы раз в сутки.


## 7) Админ‑оповещения

Сейчас отдельного админ‑чата/топика для уведомлений в коде нет. Минимальная политика до внедрения такого канала:
- список админов задаётся через `ADMIN_USER_IDS` (CSV);
- критичные уведомления (ошибки доставки/синка, истечения доступа) отправляются каждому админу из списка.

План (Milestone 2/3): добавить отдельный админ‑чат/топик для уведомлений (точное имя переменной закрепить отдельным ADR) и переключить уведомления туда.


## 8) Признаки деградации и что логировать

Логируем (внутри контейнеров и в БД в виде аудита):
- каждую попытку скачивания (ok/error + причина),
- время синхронизации каталога и число элементов,
- ошибки внешних API (Telegram/Yandex).

Это помогает отвечать на главный вопрос эксплуатации: “что сломалось и у кого”.


## История изменений
| Дата/время (MSK) | Автор | Тип | Кратко | Commit/PR |
|---|---|---|---|---|
| 2026-02-07 12:00 MSK | ChatGPT | doc | Уточнены админ‑оповещения и добавлена секция метрик (/metrics) с требованием hash-password | |
| 2026-02-06 00:10 MSK | ChatGPT | doc | Зафиксированы операции/инциденты и необходимость Local Bot API | |
| 2026-02-06 12:45 MSK | ChatGPT | doc | Синхронизированы env/Compose profiles и уточнены правила админ‑уведомлений | |

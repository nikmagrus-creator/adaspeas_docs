# HANDOFF (RU): перенос контекста в новый чат

Актуально на: 2026-02-10 23:05 MSK

Этот файл нужен, чтобы новый чат/ИИ **не пересказывал историю**, а быстро поднял актуальный контекст и правила.

Что читать первым:
1) `docs/INDEX_RU.md`
2) `docs/WORKFLOW_CONTRACT_RU.md`
3) этот файл (`docs/HANDOFF_RU.md`)
4) дальше по задаче: `docs/TECH_SPEC_RU.md`, `docs/OPS_RUNBOOK_RU.md`, `docs/PRD_RU.md`, `docs/adr/*`

## 1) Непереговорные правила процесса

- Изменения ассистент присылает **только** как инкрементальный `*.tar.gz` pack (не zip репозитория).
  - Если GitHub недоступен и нужен "полный архив" для контекста в чате: делай снимок tracked‑файлов через `git archive` (tar.gz без `.git/`, см. `deploy/make_ai_archive.sh`).
- После выдачи pack ассистент **обязан** сразу дать **один** готовый блок команд `apply → commit → push`
  (шаблон: `docs/PACK_APPLY_TEMPLATE_RU.md`, с подставленным именем файла).

- Реплика пользователя `далее` означает «продолжай текущую задачу». Если ассистент пообещал доделать "в следующем сообщении" и ещё не выдал pack (или не закрыл задачу), он продолжает ту же задачу и не переключается.
- Работаем **только** в `main` и держим линейную историю (без merge/cherry-pick/rebase).
- Сообщения коммитов: **только по-русски** (`<тип>: <кратко>`).
- Пакеты распаковываем **только локально**. На VPS только `git pull --ff-only` из `main`.

Фиксированные пути:
- Repo: `/home/nik/projects/adaspeas`
- Папка скачивания паков: `/media/nik/0C30B3CF30B3BE50/Загрузки`
- VPS: `/opt/adaspeas`

## 2) Текущее состояние системы (снимок)

Каталог:
- UI (`/categories`, inline-кнопки) читает **только SQLite**.
- Worker делает синхронизацию каталога в фоне по job `sync_catalog`.
- В SQLite хранится дерево через `path` + `parent_path` (лимит callback_data у Telegram не позволяет носить длинные пути в кнопках).

Админские команды:
- `/sync` доступна только пользователям из `ADMIN_USER_IDS`.
- Если прав нет, бот отвечает “Недостаточно прав. Ваш ID: ...”.
- Команда `/id` показывает ваш Telegram ID (для заполнения `ADMIN_USER_IDS`).

/users (админский список пользователей):
- Переписан на поиск + страницы (чтобы список не превращался в простыню и не упирался в лимит inline‑кнопок).
- Используется короткий токен сессии (таблица `admin_sessions`, schema v10), чтобы callback_data было коротким.
- callback_data для分页: `ul:<token>:<offset>` (лимит Telegram на callback_data 1–64 байта).
- Поиск: по `tg_user_id` (точное совпадение) или по `status`/`user_note` через `LIKE`.

CI / smoke:
- `ci-smoke` ждёт `/health` у bot (8080) и worker (8081).
- В GitHub Actions при генерации `.env` принудительно выставляется `CI_SMOKE=1`,
  чтобы бот не падал на фейковом токене (401 от Telegram) и поднимал `/health`.
- Есть локальная цель `make smoke`, которая генерирует `.env.smoke`, включает `CI_SMOKE=1`,
  поднимает compose и ждёт health.

DB init / устойчивость:
- v6 миграция `users.status` сделана идемпотентно (проверяет существование колонки перед `ALTER TABLE`).
- Worker тоже делает retry на инициализации БД (как bot), чтобы не падать из-за временных проблем.

Гигиена репозитория:
- `.gitignore` игнорирует `.pack/`, `adaspeas_pack_*.tar.gz`, `adaspeas_src_*.tar.gz`, `adaspeas.tar.gz`, `adaspeas.zip`, `__pycache__/`, `*.pyc`.
- В CI есть проверка: в репозитории не должно быть отслеживаемых `__pycache__/` и `.pyc`.

## 3) “Если сломалось” (коротко)

/sync → “Недостаточно прав”:
1) Выполни `/id` (или посмотри ID в сообщении отказа).
2) Добавь ID в `ADMIN_USER_IDS` в `.env`.
3) Перезапусти сервисы.

ci-smoke падает на ожидании /health:
- Почти всегда это `CI_SMOKE=0` в `.env` внутри контейнера.
- Проверяй, что `.env` создаётся из `.env.example` и затем `CI_SMOKE` принудительно перезаписывается в 1.

YAML “Invalid workflow file … yaml syntax”:
- В `name:` со строкой, содержащей `: `, значение надо брать в кавычки.

deploy на VPS падает с `sqlite3.OperationalError: duplicate column name: status`:
- Это типовой продовый случай: в базе уже есть `users.status`, но `schema_version` ещё < 6.
- В актуальном коде миграция v6 идемпотентная (перед `ALTER TABLE` проверяет через `PRAGMA table_info(users)` и пропускает, если колонка есть).
- Если ошибка всё ещё воспроизводится: значит на VPS не подтянулся `main` (проверь `git rev-parse HEAD` и что `docker compose pull` стянул свежий `latest`).

Терминал закрывается при запуске apply-блока как *Custom command*:
- Запускай блок в обычном терминале.
- Или добавляй в конец команды `; rc=$?; echo "EXIT=$rc"; read -rp "Нажми Enter..." _; exit $rc`.

## 4) Что обязательно фиксировать в конце сессии

- `docs/CHATLOG_RU.md`: цель → что сделали → решения → какие файлы/ADR обновили → следующие шаги.
- Если изменились правила/процесс/больные места для нового чата: обновить этот `docs/HANDOFF_RU.md`.

## 5) Переезд “одним махом” (без хардкода на старые pack)

Два разных сценария, не путай:

1) **Нужен контекст для нового чата/ИИ** (без `.git/`, без мусора)  
   Делай “чистый” архив только tracked‑файлов:
   - `deploy/make_ai_archive.sh` → получишь `adaspeas_src_*.tar.gz`
   - прикрепи этот архив в чат как входные данные

2) **Нужно доставить изменения в репозиторий**  
   Ассистент присылает **инкрементальный** `*.tar.gz` pack и сразу даёт один блок `apply → commit → push`
   (шаблон: `docs/PACK_APPLY_TEMPLATE_RU.md`).


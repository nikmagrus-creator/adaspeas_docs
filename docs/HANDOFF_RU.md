# HANDOFF (RU): перенос контекста в новый чат

Актуально на: 2026-02-08 20:30 MSK

Этот файл нужен, чтобы новый чат/ИИ **не пересказывал историю**, а быстро поднял актуальный контекст и правила.

Что читать первым:
1) `docs/INDEX_RU.md`
2) `docs/WORKFLOW_CONTRACT_RU.md`
3) этот файл (`docs/HANDOFF_RU.md`)
4) дальше по задаче: `docs/TECH_SPEC_RU.md`, `docs/OPS_RUNBOOK_RU.md`, `docs/PRD_RU.md`, `docs/adr/*`

## 1) Непереговорные правила процесса

- Изменения ассистент присылает **только** как инкрементальный `*.tar.gz` pack (не zip репозитория).
- После выдачи pack ассистент **обязан** сразу дать **один** готовый блок команд `apply → commit → push`
  (шаблон: `docs/PACK_APPLY_TEMPLATE_RU.md`, с подставленным именем файла).
- Работаем **только** в `main` и держим линейную историю (без merge/cherry-pick/rebase).
- Сообщения коммитов: **только по-русски** (`<тип>: <кратко>`).
- Пакеты распаковываем **только локально**. На VPS только `git pull --ff-only` из `main`.

Фиксированные пути:
- Repo: `/home/nik/projects/adaspeas`
- Папка скачивания паков: `/media/nik/0C30B3CF30B3BE50/Загрузки`
- VPS: `/opt/adaspeas`

## 2) Текущее состояние системы (снимок)

Каталог:
- UI (`/categories`, inline-кнопки) читает **только SQLite**.
- Worker делает синхронизацию каталога в фоне по job `sync_catalog`.
- В SQLite хранится дерево через `path` + `parent_path` (лимит callback_data у Telegram не позволяет носить длинные пути в кнопках).

Админские команды:
- `/sync` доступна только пользователям из `ADMIN_USER_IDS`.
- Если прав нет, бот отвечает “Недостаточно прав. Ваш ID: ...”.
- Команда `/id` показывает ваш Telegram ID (для заполнения `ADMIN_USER_IDS`).

CI / smoke:
- `ci-smoke` ждёт `/health` у bot (8080) и worker (8081).
- В GitHub Actions при генерации `.env` принудительно выставляется `CI_SMOKE=1`,
  чтобы бот не падал на фейковом токене (401 от Telegram) и поднимал `/health`.
- Есть локальная цель `make smoke`, которая генерирует `.env.smoke`, включает `CI_SMOKE=1`,
  поднимает compose и ждёт health.

Гигиена репозитория:
- `.gitignore` игнорирует `.pack/`, `adaspeas.zip`, `adaspeas_pack_*.tar.gz`, `__pycache__/`, `*.pyc`.
- В CI есть проверка: в репозитории не должно быть отслеживаемых `__pycache__/` и `.pyc`.

## 3) “Если сломалось” (коротко)

/sync → “Недостаточно прав”:
1) Выполни `/id` (или посмотри ID в сообщении отказа).
2) Добавь ID в `ADMIN_USER_IDS` в `.env`.
3) Перезапусти сервисы.

ci-smoke падает на ожидании /health:
- Почти всегда это `CI_SMOKE=0` в `.env` внутри контейнера.
- Проверяй, что `.env` создаётся из `.env.example` и затем `CI_SMOKE` принудительно перезаписывается в 1.

YAML “Invalid workflow file … yaml syntax”:
- В `name:` со строкой, содержащей `: `, значение надо брать в кавычки.

## 4) Что обязательно фиксировать в конце сессии

- `docs/CHATLOG_RU.md`: цель → что сделали → решения → какие файлы/ADR обновили → следующие шаги.
- Если изменились правила/процесс/больные места для нового чата: обновить этот `docs/HANDOFF_RU.md`.

# ADR-007: Фоновая синхронизация каталога (UI читает только SQLite)

Актуально на: 2026-02-07 19:40 MSK

- Status: Accepted
- Date (MSK): 2026-02-07 19:40 MSK
- Deciders: Nikolay, ChatGPT
- Technical Story: Milestone 1 — пункт 3 (фоновой sync каталога)

## Context
В ADR-006 была принята **lazy‑синхронизация** папки: при открытии папки бот ходит в хранилище (`list_dir(path)`) и апсертит детей.

Минусы такого подхода:
- UX зависит от доступности и скорости хранилища (первый вход в папку = сетевой запрос).
- SQLite превращается в “частичный кэш” (только посещённые папки), а UI не может работать полностью офлайн относительно хранилища.
- Для стабильности и предсказуемости нужно отделить “обновление данных” от “рендера UI”.

## Decision
1) **UI бота читает каталог только из SQLite**:
   - `nav:<id>` → выборка детей по `parent_path=<path>`.
   - бот не вызывает `list_dir` вообще.

2) **Синхронизация каталога выполняется воркером как фоновая job**:
   - добавлен `job_type` в таблицу `jobs` (миграция схемы v4);
   - новый тип `sync_catalog` рекурсивно обходит дерево хранилища от `YANDEX_BASE_PATH` и upsert’ит в `catalog_items`.

3) **Админский триггер**:
   - команда `/sync` (admin) ставит `sync_catalog` job в очередь.

4) **Метка последней синхронизации**:
   - добавлена таблица `meta` (v4) и ключ `catalog_last_sync_at`.
   - UI может показывать “обновлено …”.

## Consequences
Плюсы:
- UI становится быстрым и стабильным: кнопки работают даже если хранилище временно недоступно.
- Данные каталога консистентны (в пределах последней синхронизации), а не “частичные”.
- Синхронизацию можно развивать отдельно: расписание, инкрементальность, удалённые элементы.

Минусы/риски:
- До первого `/sync` каталог будет пуст.
- Без расписания данные могут устаревать (следующий шаг: периодический sync по cron/interval).
- Удаления на диске пока не отражаются (нужна политика удаления/soft‑delete).

## Links
- Chatlog: `docs/CHATLOG_RU.md` (запись 2026-02-07 19:40 MSK)
- Related ADRs: ADR-006 (inline nav + parent_path), ADR-005 (main‑only + repo hygiene)
